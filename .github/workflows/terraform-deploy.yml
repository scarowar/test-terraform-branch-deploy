# terraform-branch-deploy v0.2.0 trigger/execute workflow
#
# Two-phase architecture:
# - trigger: Parse PR comment, export TF_BD_* vars, STOP
# - execute: Checkout, run terraform, complete lifecycle

name: Terraform Deploy

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read
  statuses: read

concurrency:
  group: terraform-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  trigger:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    outputs:
      continue: ${{ env.TF_BD_CONTINUE }}
      environment: ${{ env.TF_BD_ENVIRONMENT }}
      operation: ${{ env.TF_BD_OPERATION }}
      sha: ${{ env.TF_BD_SHA }}
      ref: ${{ env.TF_BD_REF }}
      is_rollback: ${{ env.TF_BD_IS_ROLLBACK }}

    steps:
      - name: Trigger Mode
        uses: scarowar/terraform-branch-deploy@architecture/v0.2.0-redesign
        with:
          mode: trigger
          github-token: ${{ secrets.GITHUB_TOKEN }}

  execute:
    needs: trigger
    if: needs.trigger.outputs.continue == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.trigger.outputs.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Execute Mode
        uses: scarowar/terraform-branch-deploy@architecture/v0.2.0-redesign
        with:
          mode: execute
          github-token: ${{ secrets.GITHUB_TOKEN }}
        env:
          TF_BD_ENVIRONMENT: ${{ needs.trigger.outputs.environment }}
          TF_BD_OPERATION: ${{ needs.trigger.outputs.operation }}
          TF_BD_SHA: ${{ needs.trigger.outputs.sha }}
          TF_BD_IS_ROLLBACK: ${{ needs.trigger.outputs.is_rollback }}
