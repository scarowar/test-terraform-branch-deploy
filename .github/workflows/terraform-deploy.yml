# terraform-branch-deploy v0.2.0 - Single Job Architecture
#
# The trigger/execute pattern uses CONDITIONAL STEPS in a SINGLE JOB.
# This allows custom steps (credential injection) between phases while
# environment variables persist automatically via GITHUB_ENV.

name: Terraform Deploy

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read
  statuses: read

concurrency:
  group: terraform-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  deploy:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout first (so config file exists)
      - name: Checkout
        uses: actions/checkout@v4

      # 2. TRIGGER MODE - Parse command, export TF_BD_* to GITHUB_ENV
      - name: Trigger
        uses: scarowar/terraform-branch-deploy@architecture/v0.2.0-redesign
        with:
          mode: trigger
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # CUSTOM STEPS GO HERE
      # All TF_BD_* environment variables are available:
      #   - TF_BD_CONTINUE (true/false)
      #   - TF_BD_ENVIRONMENT (dev, prod, etc.)
      #   - TF_BD_OPERATION (plan, apply)
      #   - TF_BD_SHA
      #   - TF_BD_REF
      #   - TF_BD_IS_ROLLBACK
      #   - etc.
      # ============================================================
      
      # Example: Environment-specific credentials
      # - name: Assume AWS Role
      #   if: env.TF_BD_CONTINUE == 'true'
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     role-to-assume: ${{ env.TF_BD_ENVIRONMENT == 'prod' && 'arn:aws:iam::PROD' || 'arn:aws:iam::DEV' }}

      # 3. Checkout the correct ref (PR branch)
      - name: Checkout PR Branch
        if: env.TF_BD_CONTINUE == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TF_BD_REF }}

      # 4. EXECUTE MODE - Run terraform, complete lifecycle
      #    Picks up ALL env vars automatically (same job)
      - name: Execute
        if: env.TF_BD_CONTINUE == 'true'
        uses: scarowar/terraform-branch-deploy@architecture/v0.2.0-redesign
        with:
          mode: execute
          github-token: ${{ secrets.GITHUB_TOKEN }}
